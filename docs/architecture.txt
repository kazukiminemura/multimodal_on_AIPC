## Repository Structure
```
multimodal_on_AIPC/
├── download_models.py        # CLI helper to trigger Stable Diffusion downloads
├── docs/                     # Requirements & architecture notes
├── requirements.txt          # Python dependencies
├── src/app/
│   ├── __init__.py
│   ├── config.py             # Environment-driven settings (endpoints, cache dirs, toggles)
│   ├── download_models.py    # Async entry point used by the CLI wrapper
│   ├── image_client.py       # Stable Diffusion INT8 OpenVINO client (mock + HTTP)
│   ├── main.py               # FastAPI app factory, startup hooks, static assets
│   ├── model_downloader.py   # Hugging Face snapshot helper for Stable Diffusion weights
│   ├── routes.py             # `/image` and `/health` endpoints
│   └── schemas.py            # Pydantic models used by the API
└── static/                   # index.html, chat.js, style.css, mock-image.svg
```

## Initialization Flow
1. `uvicorn main:app --reload` boots FastAPI from the project root (or `uvicorn app.main:app --app-dir src`).
2. `src/app/main.py` mounts the static UI, registers API routes, and stores the configured `StableDiffusionClient` in `app.state`.
3. During startup, `ensure_models()` makes sure the Stable Diffusion snapshot from Hugging Face is cached under `data/models/stable-diffusion`. Downloads respect `AUTO_DOWNLOAD_MODELS` and use `huggingface_hub.snapshot_download`.
4. Requests to `/image` are validated against `ImageGenerationRequest` and then sent to the `StableDiffusionClient`, which either calls the remote endpoint or returns the mock payload.

## Runtime Components
- **Settings** – Provides environment-driven configuration via `pydantic_settings`. Handles cache directories, HTTP timeouts, repo IDs, and mock toggles.
- **StableDiffusionClient** – Thin async wrapper over an OpenAI-compatible Stable Diffusion endpoint. Includes a mock branch for offline testing and handles payload shaping.
- **ModelDownloader** – Shared helper that mirrors the Hugging Face repo into `data/models/stable-diffusion`. Exposed via the CLI to stage assets manually.
- **FastAPI Routes** – `/image` returns `ImageGenerationResponse` objects; `/health` exposes model-cache and mock status.
- **Static UI** – Vanilla HTML/CSS/JS client that submits prompts from the browser, renders returned URLs, and stores a small session history.

## Request Lifecycle
1. Browser or API client POSTs an `ImageGenerationRequest` (prompt + optional parameters) to `/image`.
2. FastAPI validates the payload and resolves `StableDiffusionClient` from the application state.
3. The client sends a JSON request to `STABLE_DIFFUSION_ENDPOINT` unless `USE_MOCKS=true`.
4. The resulting URLs and metadata are wrapped in `ImageGenerationResponse` and returned to the caller. The UI appends the card to the gallery view.

## Configuration Surface
Environment variables parsed in `config.py` include:
- `USE_MOCKS`, `AUTO_DOWNLOAD_MODELS`, `REQUEST_TIMEOUT`
- `MODELS_CACHE_DIR`, `STABLE_DIFFUSION_REPO_ID`, `STABLE_DIFFUSION_ENDPOINT`
- `HUGGINGFACE_TOKEN` for gated downloads

Models are cached within `<MODELS_CACHE_DIR>/stable-diffusion`. The CLI (`python download_models.py`) ignores mock settings so deployments can pre-stage files.

## Deployment Considerations
- Host the Stable Diffusion inference server on the same machine (OpenVINO runtime) or expose it via an internal network endpoint.
- Front FastAPI with a reverse proxy for TLS, authentication, and rate limiting if exposing beyond localhost.
- Persist generated images to durable storage or synchronize with object storage when the gallery needs long-term retention.
- Add monitoring (Prometheus, OpenTelemetry) to capture inference latency, download status, and HTTP error rates.

## Testing & Validation
- Unit-test configuration parsing, payload validation, and the mock generation branch.
- Mock the Stable Diffusion HTTP client to verify `/image` and `/health` responses.
- Exercise `python download_models.py` in automated pipelines to catch authentication or permission regressions (can be skipped via environment flags).
